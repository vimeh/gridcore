<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rust WASM Core Test</title>
    <style>
        body {
            font-family: 'SF Pro Display', -apple-system, BlinkMacSystemFont, sans-serif;
            margin: 20px;
            background: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            margin-bottom: 20px;
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            background: #f9f9f9;
            border-radius: 4px;
            border-left: 4px solid #4CAF50;
        }
        .test-section.error {
            border-left-color: #f44336;
        }
        .test-section.warning {
            border-left-color: #ff9800;
        }
        .status {
            font-weight: bold;
            margin-bottom: 10px;
        }
        .success { color: #4CAF50; }
        .error { color: #f44336; }
        .warning { color: #ff9800; }
        pre {
            background: #282c34;
            color: #abb2bf;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
        }
        button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #45a049;
        }
        #spreadsheet {
            width: 100%;
            height: 400px;
            border: 1px solid #ddd;
            margin: 20px 0;
            position: relative;
            overflow: auto;
        }
        .cell {
            position: absolute;
            border: 1px solid #e0e0e0;
            padding: 4px;
            width: 100px;
            height: 30px;
            background: white;
            box-sizing: border-box;
        }
        .cell.active {
            border: 2px solid #4CAF50;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ðŸ¦€ Rust WASM Core Test</h1>
        
        <div class="test-section">
            <div class="status">Loading WASM Module...</div>
            <div id="load-status"></div>
        </div>

        <div class="test-section">
            <div class="status">Basic Operations</div>
            <button onclick="testBasicOps()">Test Basic Operations</button>
            <button onclick="testFormulas()">Test Formulas</button>
            <button onclick="testWorkbook()">Test Workbook</button>
            <div id="test-results"></div>
        </div>

        <div class="test-section">
            <div class="status">Interactive Spreadsheet</div>
            <div id="spreadsheet"></div>
            <div>
                <button onclick="addSheet()">Add Sheet</button>
                <button onclick="switchSheet()">Switch Sheet</button>
                <span id="current-sheet">Sheet1</span>
            </div>
        </div>

        <div class="test-section">
            <div class="status">Console Output</div>
            <pre id="console"></pre>
        </div>
    </div>

    <script type="module">
        let wasmModule = null;
        let workbook = null;
        let facade = null;
        let currentSheet = 'Sheet1';
        
        function log(message, type = 'info') {
            const consoleEl = document.getElementById('console');
            const timestamp = new Date().toISOString().split('T')[1].slice(0, 8);
            const color = type === 'error' ? '#f44336' : type === 'warning' ? '#ff9800' : '#4CAF50';
            consoleEl.innerHTML += `<span style="color: ${color}">[${timestamp}] ${message}</span>\n`;
            console.log(message);
        }

        async function loadWasm() {
            const statusEl = document.getElementById('load-status');
            try {
                log('Importing WASM module...');
                const module = await import('/src/wasm/gridcore_wasm.js');
                
                log('Initializing WASM...');
                await module.default();
                
                wasmModule = module;
                log('WASM module loaded successfully!', 'success');
                statusEl.innerHTML = '<span class="success">âœ“ WASM Module Loaded</span>';
                
                // Initialize workbook
                workbook = new module.WasmWorkbook();
                facade = workbook.getActiveFacade();
                log('Workbook initialized with default sheet');
                
                // Render initial grid
                renderGrid();
                
                return true;
            } catch (error) {
                log(`Error loading WASM: ${error}`, 'error');
                statusEl.innerHTML = `<span class="error">âœ— Failed to load: ${error}</span>`;
                return false;
            }
        }

        function renderGrid() {
            const container = document.getElementById('spreadsheet');
            container.innerHTML = '';
            
            // Create a simple 10x10 grid
            for (let row = 0; row < 10; row++) {
                for (let col = 0; col < 10; col++) {
                    const cell = document.createElement('div');
                    cell.className = 'cell';
                    cell.style.left = `${col * 100}px`;
                    cell.style.top = `${row * 30}px`;
                    cell.contentEditable = true;
                    cell.dataset.row = row;
                    cell.dataset.col = col;
                    
                    // Get cell value
                    const addr = new wasmModule.WasmCellAddress(col, row);
                    const value = facade.getCellValue(addr);
                    cell.textContent = value || '';
                    addr.free();
                    
                    // Handle cell edit
                    cell.addEventListener('blur', (e) => {
                        const addr = new wasmModule.WasmCellAddress(
                            parseInt(e.target.dataset.col),
                            parseInt(e.target.dataset.row)
                        );
                        facade.setCellValue(addr, e.target.textContent);
                        addr.free();
                        renderGrid(); // Re-render to show computed values
                    });
                    
                    container.appendChild(cell);
                }
            }
        }

        window.testBasicOps = function() {
            if (!wasmModule) {
                log('WASM not loaded', 'error');
                return;
            }
            
            const resultsEl = document.getElementById('test-results');
            let results = '<h4>Basic Operations Test:</h4><ul>';
            
            try {
                // Test 1: Set and get cell value
                const addr1 = new wasmModule.WasmCellAddress(0, 0);
                facade.setCellValue(addr1, "42");
                const value1 = facade.getCellValue(addr1);
                results += `<li>Set A1 = 42: ${value1 === 42 ? 'âœ“' : 'âœ—'} (got ${value1})</li>`;
                addr1.free();
                
                // Test 2: Set string value
                const addr2 = new wasmModule.WasmCellAddress(1, 0);
                facade.setCellValue(addr2, "Hello Rust!");
                const value2 = facade.getCellValue(addr2);
                results += `<li>Set B1 = "Hello Rust!": ${value2 === "Hello Rust!" ? 'âœ“' : 'âœ—'}</li>`;
                addr2.free();
                
                // Test 3: Clear cell
                const addr3 = new wasmModule.WasmCellAddress(0, 0);
                facade.clearCell(addr3);
                const value3 = facade.getCellValue(addr3);
                results += `<li>Clear A1: ${value3 === null || value3 === undefined ? 'âœ“' : 'âœ—'}</li>`;
                addr3.free();
                
                results += '</ul>';
                resultsEl.innerHTML = results;
                log('Basic operations test completed');
                
                renderGrid();
            } catch (error) {
                log(`Test error: ${error}`, 'error');
                resultsEl.innerHTML = `<span class="error">Test failed: ${error}</span>`;
            }
        };

        window.testFormulas = function() {
            if (!wasmModule) {
                log('WASM not loaded', 'error');
                return;
            }
            
            const resultsEl = document.getElementById('test-results');
            let results = '<h4>Formula Test:</h4><ul>';
            
            try {
                // Set up test data
                const a1 = new wasmModule.WasmCellAddress(0, 0);
                const b1 = new wasmModule.WasmCellAddress(1, 0);
                const c1 = new wasmModule.WasmCellAddress(2, 0);
                
                facade.setCellValue(a1, "10");
                facade.setCellValue(b1, "20");
                facade.setCellValue(c1, "=A1+B1");
                
                const result = facade.getCellValue(c1);
                results += `<li>Formula =A1+B1: ${result === 30 ? 'âœ“' : 'âœ—'} (got ${result})</li>`;
                
                // Test SUM function
                const d1 = new wasmModule.WasmCellAddress(3, 0);
                facade.setCellValue(d1, "=SUM(A1:B1)");
                const sumResult = facade.getCellValue(d1);
                results += `<li>Formula =SUM(A1:B1): ${sumResult === 30 ? 'âœ“' : 'âœ—'} (got ${sumResult})</li>`;
                
                a1.free();
                b1.free();
                c1.free();
                d1.free();
                
                results += '</ul>';
                resultsEl.innerHTML = results;
                log('Formula test completed');
                
                renderGrid();
            } catch (error) {
                log(`Formula test error: ${error}`, 'error');
                resultsEl.innerHTML = `<span class="error">Test failed: ${error}</span>`;
            }
        };

        window.testWorkbook = function() {
            if (!wasmModule) {
                log('WASM not loaded', 'error');
                return;
            }
            
            const resultsEl = document.getElementById('test-results');
            let results = '<h4>Workbook Test:</h4><ul>';
            
            try {
                // Get sheet count
                const count = workbook.getSheetCount();
                results += `<li>Initial sheet count: ${count}</li>`;
                
                // Create new sheet
                workbook.createSheet("TestSheet");
                const newCount = workbook.getSheetCount();
                results += `<li>After creating sheet: ${newCount} sheets</li>`;
                
                // Get sheet names
                const names = Array.from(workbook.getSheetNames());
                results += `<li>Sheet names: ${names.join(', ')}</li>`;
                
                // Switch to new sheet
                workbook.setActiveSheet("TestSheet");
                facade = workbook.getActiveFacade();
                const activeName = workbook.getActiveSheetName();
                results += `<li>Active sheet: ${activeName}</li>`;
                
                results += '</ul>';
                resultsEl.innerHTML = results;
                log('Workbook test completed');
            } catch (error) {
                log(`Workbook test error: ${error}`, 'error');
                resultsEl.innerHTML = `<span class="error">Test failed: ${error}</span>`;
            }
        };

        window.addSheet = function() {
            if (!workbook) return;
            
            const sheetName = `Sheet${workbook.getSheetCount() + 1}`;
            try {
                workbook.createSheet(sheetName);
                log(`Created sheet: ${sheetName}`);
                currentSheet = sheetName;
                document.getElementById('current-sheet').textContent = currentSheet;
                workbook.setActiveSheet(sheetName);
                facade = workbook.getActiveFacade();
                renderGrid();
            } catch (error) {
                log(`Error creating sheet: ${error}`, 'error');
            }
        };

        window.switchSheet = function() {
            if (!workbook) return;
            
            const names = Array.from(workbook.getSheetNames());
            const currentIndex = names.indexOf(currentSheet);
            const nextIndex = (currentIndex + 1) % names.length;
            const nextSheet = names[nextIndex];
            
            try {
                workbook.setActiveSheet(nextSheet);
                facade = workbook.getActiveFacade();
                currentSheet = nextSheet;
                document.getElementById('current-sheet').textContent = currentSheet;
                log(`Switched to sheet: ${nextSheet}`);
                renderGrid();
            } catch (error) {
                log(`Error switching sheet: ${error}`, 'error');
            }
        };

        // Load WASM on page load
        window.addEventListener('load', loadWasm);
    </script>
</body>
</html>