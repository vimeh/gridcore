<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Performance Metrics Test</title>
</head>
<body>
    <h1>Performance Metrics Test</h1>
    <p>This page will open the GridCore app and test performance metrics.</p>
    <button onclick="testPerformance()">Test Performance</button>
    <iframe id="gridcore" src="http://localhost:8080" width="100%" height="600"></iframe>
    
    <div id="results" style="margin-top: 20px; padding: 10px; border: 1px solid #ccc;">
        <h2>Test Results:</h2>
        <pre id="output"></pre>
    </div>

    <script>
        function log(msg) {
            const output = document.getElementById('output');
            output.textContent += msg + '\n';
            console.log(msg);
        }

        async function testPerformance() {
            log('Starting performance test...');
            
            const iframe = document.getElementById('gridcore');
            const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
            const iframeWin = iframe.contentWindow;
            
            // Wait for the iframe to load
            await new Promise(resolve => {
                if (iframe.contentDocument.readyState === 'complete') {
                    resolve();
                } else {
                    iframe.onload = resolve;
                }
            });
            
            log('GridCore loaded');
            
            // Enable Demo Mode
            const demoCheckbox = iframeDoc.querySelector('input[type="checkbox"]');
            if (demoCheckbox && demoCheckbox.nextSibling.textContent.includes('Demo Mode')) {
                demoCheckbox.click();
                log('Demo Mode enabled');
            }
            
            await new Promise(resolve => setTimeout(resolve, 500));
            
            // Click Performance button
            const buttons = Array.from(iframeDoc.querySelectorAll('button'));
            const perfButton = buttons.find(b => b.textContent === 'Performance');
            if (perfButton) {
                perfButton.click();
                log('Performance overlay enabled');
            }
            
            await new Promise(resolve => setTimeout(resolve, 500));
            
            // Select "Basic Operations" (should be selected by default)
            const select = iframeDoc.querySelector('select');
            if (select) {
                select.value = 'Basic Operations';
                log('Selected: Basic Operations');
            }
            
            // Click Start button
            const startButton = buttons.find(b => b.textContent === 'Start');
            if (startButton) {
                startButton.click();
                log('Demo started');
            }
            
            // Monitor performance metrics for 5 seconds
            log('\nMonitoring performance metrics...');
            
            for (let i = 0; i < 10; i++) {
                await new Promise(resolve => setTimeout(resolve, 500));
                
                // Check performance overlay values
                const overlay = iframeDoc.querySelector('.performance-overlay');
                if (overlay) {
                    const metrics = {};
                    const metricDivs = overlay.querySelectorAll('.metric');
                    metricDivs.forEach(div => {
                        const label = div.querySelector('.metric-label')?.textContent.replace(':', '').trim();
                        const value = div.querySelector('.metric-value')?.textContent.trim();
                        if (label && value) {
                            metrics[label] = value;
                        }
                    });
                    
                    log(`\nTime ${i * 0.5}s - Metrics: ${JSON.stringify(metrics, null, 2)}`);
                    
                    // Check console logs from iframe
                    if (iframeWin.console && iframeWin.console.logs) {
                        log('Console logs: ' + iframeWin.console.logs.join(', '));
                    }
                }
            }
            
            // Stop the demo
            const stopButton = buttons.find(b => b.textContent === 'Stop');
            if (stopButton) {
                stopButton.click();
                log('\nDemo stopped');
            }
            
            log('\nTest complete!');
        }
    </script>
</body>
</html>